(function(a){var d=a({});a.ajaxQueue=function(c){function b(h){f=a.ajax(c).done(e.resolve).fail(e.reject).then(h,h)}var f,e=a.Deferred(),g=e.promise();d.queue(b);g.abort=function(h){if(f)return f.abort(h);var i=d.queue(),j=a.inArray(b,i);j>-1&&i.splice(j,1);e.rejectWith(c.context||c,[g,h,""]);return g};return g}})(jQuery);
function price_currency(a){a=unescape(escape(a).replace("%A0",""));var d=/([\d\s\,\.]*)/.exec(a);d=d[0].replace(/\s/g,"");var c=a.split(" ");a=d.replace(",",".");d=c[1];return{price:parseFloat(a),currency:d}}
function number_format(a,d){function c(e,g){var h={};for(key in e)h[key]=typeof g[key]!=="undefined"?g[key]:e[key];return h}function b(e,g){if(e.length<=3)return e;for(var h="",i=0,j=e.length-1;j>=0;j--){var k=e.substr(j,1);if(i%3==0&&i!=0&&!isNaN(parseFloat(k)))h=g+h;h=k+h;i++}return h}if(typeof a!=="number"){a=parseFloat(a);if(isNaN(a))return false}var f={before:"",after:"",decimals:2,dec_point:".",thousands_sep:","};d=d&&typeof d==="object"?c(f,d):f;a=a.toFixed(d.decimals);if(a.indexOf(".")!=-1){f=
a.split(".");a=b(f[0],d.thousands_sep)+d.dec_point+f[1]}else a=b(a,d.thousands_sep);return d.before+a+d.after}function format(a,d){return number_format(ceil_funds(a),{after:" "+d,thousands_sep:" ",dec_point:","})}
function CartItem(a){var d=$("#cartItemTmpl").template("cartItemTmpl"),c=$("#deletedItemTmpl").template("deletedItemTmpl");$("#addPackTmpl").template("addPackTmpl");$("cart_item_"+a.id);var b=this;b.type="item";$.extend(b,a);b.pc=price_currency(b.price);b=$.tmplItem($.tmpl({item:"cartItemTmpl",delitem:"deletedItemTmpl",pack:"addPackTmpl"}[b.type],b,{format:format,cartI18N:cartI18N}));b.cart=a.cart;b.id=a.id;b.render=function(){if(b.data.type=="delitem"&&b.tmpl!==c)b.tmpl=c;else if(b.data.type=="item"&&
b.tmpl!==d)b.tmpl=d;b.update();$(".qty-button,.del-button,.res-button",b.nodes).bind("click",function(){switch($(this).attr("class")){case "qty-button":b.add_qty.apply(this);break;case "del-button":b.del_item.apply(this);break;case "res-button":b.restore_item.apply(this)}});b.$input_qty=$('input[name="quantity"]',b.nodes);b.$input_qty.numeric();b.$input_qty.bind("change",function(){b.set_qty.apply(this)});return b.nodes};b.add_qty=function(f){if(f===undefined)f=parseInt($(this).attr("x-inc"));f=parseInt(b.data.q)+
f;b.$input_qty.val(f);return b.set_qty()};b.del_item=function(){b.data.type="delitem";b.data.changed=true;b.cart.updateDeletedItems("add",{1:b})};b.restore_item=function(){b.data.type="item";if(b.cart.cart_items[b.data.id]){b.cart.updateDeletedItems("remove",{1:b});b.cart.render();b.cart.countdown(CART_COUNTDOWNTIME,b.cart.redraw_count,b.cart.check)}else{$(this).remove();$("#restd_"+b.data.id).paintLoader({canvas_id:"res_loading",diameter:12,density:71,range:1.1,speed:8,css:{position:"relative","text-align":"center"}});
b.cart.ajax_add(b.data.product_id,b.data.q,function(){b.cart.updateDeletedItems("remove",{1:b})})}};b.set_qty=function(){var f=cldr.numberParser()(b.$input_qty.val());if(f<=0){b.del_item();return false}var e=f-b.data.q,g=e*b.data.pc.price;b.data.q=f;b.data.changed=true;with(b.cart){updateItemsCnt(e);total+=g;render();change_form()}};return b}
function Cart(){var a=this;$("#cartTmpl").template("cartTmpl");a.provider_id=0;a.provider_name="";a.total=0;a._itemsCnt=0;a.weightTotal=0;a.cart_items={};a._deleted_items={};a.use_weight=true;a.fstock=false;a.lock=0;a.check_answer_timeout=null;a.countdown_timeout=null;var d=$.tmplItem($.tmpl("cartTmpl",a,{format:format,cartI18N:cartI18N}));a.init=function(c,b,f){a.cw=c;a.get_success(b,f);$("#clear_deleted").bind("click."+a.id,function(e){e.preventDefault();a.clear_deleted_items()});return d.nodes};
a.destroy=function(){$("#clear_deleted").unbind("click."+a.id)};a.get_success=function(c,b){if(c!=null){a.id=c.id;a.provider_id=c.provider_id;if(c.provider_name)a.provider_name=c.provider_name;a.cart_items={};a.updateItemsCnt();a.total=a.weightTotal=0;a.fstock=false;a.currency=c.currency;$.each(c.items,function(f,e){if(f==0)a.use_weight=e.use_weight;if(e.in_stock<=0)a.fstock=true;a.cart_items[e.id]=new CartItem({cart:a,id:e.id,product_id:e.product_id,name:e.name,wght:e.weight,stock:e.in_stock,price:e.price,
q:e.qty,thb_url:e.thb_url,use_weight:e.use_weight});a.total+=price_currency(e.price).price*e.qty;a.updateItemsCnt(e.qty);a.weightTotal+=e.weight*e.qty});a.old_cart_items=a.cart_items}else{a.cart_items={};a.updateItemsCnt();a.total=a.weightTotal=0;a.cw.checkEmptyCarts()}a.render();b!=undefined&&b();return c?true:false};a.open=function(c){a.$postage.empty();c!=undefined&&!c?a.countdown(CART_COUNTDOWNTIME,a.redraw_count,a.check):a.countdown(CART_COUNTDOWNTIME,a.redraw_count,a.update)};a.close=function(){a.stop_countdown();
a.stop_check_answer()};a.updateItemsCnt=function(c){old_cnt=a._itemsCnt;new_cnt=c!=undefined?old_cnt+c:0;a._itemsCnt=new_cnt;a.cw.updateSumCountItems(new_cnt-old_cnt)};a.isEmpty=function(){cnt=0;for(x in a.cart_items)if(a.cart_items[x].data.type=="item")cnt+=1;return cnt==0?true:false};a.updateDeletedItems=function(c,b){switch(c){case "add":a.purgeCheckShipping();for(id in b){a.cw.deletedItemsCount++;for(var f in a._deleted_items)if(a._deleted_items[f].data.product_id==b[id].data.product_id){delete a._deleted_items[f];
a.cw.deletedItemsCount--;break}a._deleted_items[b[id].data.id]=b[id];a.updateItemsCnt(-b[id].data.q)}if(a.isEmpty()){a.set_qty_ajax();a.purge_items();a.render()}else{a.render();a.countdown(CART_COUNTDOWNTIME,a.redraw_count,a.update)}break;case "remove":for(f in b){$(b[f].nodes).remove();delete a._deleted_items[b[f].data.id];a.cw.deletedItemsCount--}}a.render_deleted_items()};a.purgeCheckShipping=function(){a.stop_countdown();a.stop_check_answer();a.$postage.empty();a.$ajaxloading.hide();a.removeAddPack()};
a.render=function(){d.update();var c=$(".cart_table_head",d.nodes);a.$cart_table=$(".cart_table",d.nodes);a.$reg_form=$(".register_form",d.nodes);a.$postage=$(".postage",d.nodes);a.$ajaxloading=$(".cart-ajax-loading",d.nodes);a.$timer_block=$(".timer_block",d.nodes);a.$countdown=$(".countdown",d.nodes);for(id in a.cart_items)a.cart_items[id].data.type!="delitem"&&c.after(a.cart_items[id].render());a.recalTotalWeight();a.bind_events()};a.bind_events=function(){$(d.nodes).on("click",".cart_other_product .btn",
function(c){c.preventDefault();a.ajax_add($(this).data("product_id"),1,a.check)}).on("click",".cart_other_product_wo_check .btn",function(c){c.preventDefault();a.ajax_add($(this).data("product_id"),1)}).on("click",".start-check-now",function(c){c.preventDefault();a.update()}).on("click",".cart-clear",a.clear).on("click",".post-method-row",function(){$(".post-method-row",$(this).parent()).removeClass("active");$(this).addClass("active");var c=$(this).find('label:contains("'+gettext("\u0431\u0435\u0437 \u043e\u0442\u0441\u043b\u0435\u0436\u0438\u0432\u0430\u043d\u0438\u044f")+
'")').length,b=$(".insurance_row",d.nodes),f=$(this).data("insurance_fee"),e=$(this).data("insurance_total");if(c){$(".insurance",b).attr("disabled","disabled").removeAttr("checked");$(".insurance_amount",b).empty();b.css("background","#eaeaea")}else{$(".insurance",b).removeAttr("disabled");$(".insurance_amount",b).empty();b.css("background","#E9FCDD");$(".insurance_amount",b).html("<nobr>"+f+"</nobr>");$(".insurance:checked",b).length?$(".cart-insur-total",b).html("<nobr><strong>"+e+"</strong></nobr>"):
$(".cart-insur-total",b).empty()}}).on("click",".insurance_row",function(){$(".post-method-row.active",$(this).parent()).click()})};a.render_deleted_items=function(){var c=$("#cart_deleted_table_head");for(id in a._deleted_items)c.after(a._deleted_items[id].render());a.cw.deletedItemsCount==0?$("#deleted_items").hide():$("#deleted_items").show()};a.recalTotalWeight=function(){var c=0;$(".wght",d.nodes).each(function(b,f){c+=parseInt($(f).html())});$(".cart_weight_summ",d.nodes).html(cldrFmt.weightGram(c));
a.weightTotal=c};a.set_qty_start=function(){qty={};is_empty=true;for(var c in a.cart_items){is_empty=false;if(a.cart_items[c].data.changed)qty[c]=a.cart_items[c].data.type=="delitem"?0:a.cart_items[c].data.q}if(country)qty.country=country;return is_empty};a.set_qty_success=function(c,b){c.status!=0&&alert(c.error);b&&b()};a.set_qty_ajax=function(c,b){if(b==undefined)b=true;a.set_qty_start()?c():$.ajax({url:"/cart/"+a.id+"/qty/ajax/?r="+Math.random(),data:qty,type:"POST",dataType:"json",async:b,success:function(f){a.set_qty_success(f,
c)}})};a.purge_items=function(){for(var c in a.cart_items)a.cart_items[c].data.type=="delitem"&&delete a.cart_items[c]};a.update=function(){var c=++a.lock;a.old_cart_items=a.cart_items;if(!a.set_qty_start())if(!a.check_start()){a.stop_countdown();a.cw.addres_exists&&a.$ajaxloading.show();$.ajaxQueue({url:"/cart/"+a.id+"/update/ajax/",type:"POST",dataType:"json",data:qty,success:function(b){if(c==a.lock)if(a.cart_items==a.old_cart_items)if(a.get_success(b.cart))if(!a.isEmpty()){a.set_qty_success(b.qty,
false);a.check_success(b.cartcheck);a.purge_items()}},error:function(){}})}};a.clear=function(c){for(var b in a.cart_items){a.cart_items[b].data.type="delitem";a.cart_items[b].data.changed=true}a.set_qty_ajax(function(){a.updateDeletedItems("add",a.cart_items);c&&typeof c==="function"&&c()})};a.clear_deleted_items=function(){if(!jQuery.isEmptyObject(a._deleted_items)){a.set_qty_ajax(function(){a.purge_items();a.updateDeletedItems("remove",a._deleted_items)});a.cw.checkEmptyCarts()}};a.change_form=
function(){a.stop_check_answer();a.$postage.empty();a.countdown(CART_COUNTDOWNTIME,a.redraw_count,a.update)};a.countdown=function(c,b,f){b(c);if(c>0){a.stop_countdown(0);a.countdown_timeout=setTimeout(function(){a.countdown(c-1,b,f)},1E3)}else f()};a.stop_countdown=function(c){clearTimeout(a.countdown_timeout);c===undefined&&a.$timer_block.hide()};a.redraw_count=function(c){a.$timer_block.show();a.$ajaxloading.hide();a.$countdown.html(c)};a.removeAddPack=function(){$(".addPack",d.nodes).remove();
a.recalTotalWeight()};a.appendAddPack=function(c){$.each(c,function(b,f){var e=new CartItem({cart:a,id:0,product_id:0,name:gettext("\u0414\u043e\u043f\u043e\u043b\u043d\u0438\u0442\u0435\u043b\u044c\u043d\u044b\u0439 \u0443\u043f\u0430\u043a\u043e\u0432\u043e\u0447\u043d\u044b\u0439 \u043c\u0430\u0442\u0435\u0440\u0438\u0430\u043b"),stock:50,q:f.quantity,wght:f.weight,price:f.price,thb_url:"/static/images/newdesign/cart/addPack.png",type:"pack"});$('tr[id*="cart_item_"]:last',a.$cart_table).after(e.render())});
a.recalTotalWeight()};a.check_start=function(){a.removeAddPack();a.stop_check_answer();if(!a.cw.dialog("isOpen"))return true;a.old_cart_items=a.cart_items;return a.isEmpty()?true:false};a.check_success=function(c){if(a.old_cart_items==a.cart_items){if(!c)return false;if(typeof c!="object")c=$.parseJSON(c);var b=c.cartcheck_order_id;if(c.relogin){a.$postage.html(c.relogin);return false}if(c.country){country=c.country;$("#select_country option[value="+c.country+"]").attr("selected","selected")}a.check_answer(b)}};
a.check=function(){a.check_start()||$.ajaxQueue({url:"/cart/"+a.id+"/cartcheck/ajax/?r="+Math.random(),type:"POST",success:a.check_success})};a.stop_check_answer=function(){clearTimeout(a.check_answer_timeout)};a.switchCheckoutBnt=function(c){var b=$("#checkout-btn");c==1?b.removeAttr("disabled").unbind("click"):b.attr("disabled","disabled").bind("click",function(){return false})};a.check_answer=function(c){a.cbe_order_id=c;a.$postage.empty();a.$timer_block.hide();a.$ajaxloading.show();$.ajax({type:"GET",
url:"/ajax/check_cart/get_answer_cart/"+c+"/?"+Math.random()+(country?"&country="+country:""),success:a.cbe_ajax_result,error:function(){a.stop_check_answer();a.$ajaxloading.hide();a.$postage.html('<div style="padding-left: 25px;">'+gettext("\u0418\u0437\u0432\u0438\u043d\u0438\u0442\u0435, \u043d\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\u0435 \u043f\u0440\u043e\u0438\u0437\u043e\u0448\u043b\u0430 \u043e\u0448\u0438\u0431\u043a\u0430.<br />\u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435, \u043f\u043e\u0436\u0430\u043b\u0443\u0439\u0441\u0442\u0430, \u043e\u0431\u043d\u043e\u0432\u0438\u0442\u044c \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0443 \u043f\u043e\u0437\u0436\u0435.")+
"</div>")},dataType:"json"})};a.cbe_ajax_result=function(c){if(c.hasOwnProperty("message"))c.message=c.message.replace("{{domain}}",window.location.hostname.replace("www.",""));switch(c.result){case 1:case 2:a.$ajaxloading.hide();a.$postage.append(c.message);$("input:radio:checked",a.$postage).click();a.switchCheckoutBnt(1);c.shipping||a.switchCheckoutBnt(0);a.appendAddPack(c.addPack);break;case 3:a.switchCheckoutBnt(0);a.$postage.html('<div class="ajax-cart-products_box">'+c.message+"</div>");a.$ajaxloading.hide();
break;case 4:a.stop_check_answer();a.check_answer_timeout=setTimeout(function(){a.check_answer(a.cbe_order_id)},5E3);break;case 5:a.switchCheckoutBnt(0);a.$postage.html('<div class="ajax-cart-products_box">'+c.message+"</div>");a.$ajaxloading.hide();break;case 6:window.location.href="/accounts/login/?next=/shop/cart/";break;case 7:a.$ajaxloading.hide();a.$postage.append(c.message);c.equalCarts&&$.each(c.equalCarts,function(b,f){var e=new Cart;a.cw.$carts_list.append(e.init(a.cw,f));a.cw.carts[e.provider_id]=
e;e.check()});break;default:a.stop_check_answer();a.$ajaxloading.hide();a.$postage.html('<div style="padding-left: 25px;">'+gettext("\u0418\u0437\u0432\u0438\u043d\u0438\u0442\u0435, \u043d\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\u0435 \u043f\u0440\u043e\u0438\u0437\u043e\u0448\u043b\u0430 \u043e\u0448\u0438\u0431\u043a\u0430.<br />\u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439\u0442\u0435, \u043f\u043e\u0436\u0430\u043b\u0443\u0439\u0441\u0442\u0430, \u043e\u0431\u043d\u043e\u0432\u0438\u0442\u044c \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0443 \u043f\u043e\u0437\u0436\u0435.")+
"</div>")}};a.ajax_add=function(c,b,f){for(var e in a.cart_items)if(a.cart_items[e].data.product_id==c){a.cart_items[e].add_qty(parseInt(b),true);return false}$.ajax({type:"POST",url:"/add/",data:{productname:c,quantity:b,addwish:""},dataType:"json",success:function(g){a.cw.add_success(g);f!=undefined&&f()},error:function(g,h,i){alert(i)}})}}var country;
function CartWrapper(){var a;if($.cookie("currency")=="UAH"){country="UA";$("#select_country option[value="+country+"]").attr("selected","selected")}a=$("#cart_wrapper").dialog({modal:true,autoOpen:false,resizable:false,draggable:false,width:950,position:{my:"center top",at:"center top+50",of:window},title:cartI18N.title,close:function(){$.hashdata.remove("popupopen");$.each(a.carts,function(d,c){c.close()})}});a=$.extend(a,{need_update_carts:true,$addres_form:$("#cart-ship-address-form"),$addres_info:$("#cart-ship-address-info"),
$carts_list:$("#carts_list"),$cart_count:$("#cart_count"),$empty_cart:$("#empty-cart"),deletedItemsCount:0,sumCountItems:0,carts:{}});$.ajax({url:"/cart/get_carts_info/",dataType:"json",success:function(d){a.render(d)}});a.render_address_block=function(d){if(d.carts.length){a.addres_exists=false;if(d.addresse_form){a.$addres_form.html(d.addresse_form);if(d.addresse_html){ship_addr_html='<div id="cart-ship-address-txt"><strong>'+cartI18N.shipping+": </strong>"+d.addresse_html+'</div><div class="pull-right"><a id="cart-btnedit-address" href="#"><i class="icon-pencil"></i> '+
cartI18N.shipping_address_edit+'</a></div><div class="clear"/>';a.$addres_info.html(ship_addr_html).show();a.addres_exists=true}}else a.addres_exists=true;if(a.addres_exists&&!d.form_error){a.$addres_form.hide();a.$addres_info.show()}else a.$addres_form.show()}else a.$addres_info.hide()};a.render=function(d,c){a.$carts_list.empty();$.each(a.carts,function(f,e){e.destroy()});a.carts={};a.updateSumCountItems();a.render_address_block(d);if(d.carts.length){a.$empty_cart.hide();$.each(d.carts,function(f,
e){var g=new Cart;a.$carts_list.append(g.init(a,e));a.carts[g.provider_id]=g});var b=$.hashdata.get("popupopen");if(b&&b=="Cart"||c){a.need_update_carts=false;a.dialog("isOpen")?a.trigger("dialogopen"):a.dialog("open")}}else a.$empty_cart.show()};a.updateSumCountItems=function(d){var c=a.$cart_count.text();new_cnt=d==undefined?0:c==""?0:parseInt(c)+d;a.$cart_count.html(new_cnt);new_cnt<=0?a.$cart_count.hide():a.$cart_count.show()};a.checkEmptyCarts=function(){if(a.$cart_count.text()==0){a.$carts_list.empty();
a.$addres_form.hide();a.$addres_info.hide();a.$empty_cart.show()}};a.add_success=function(d){$("#prod_add_loader").remove();d.add&&d.add.errors[0]!=undefined&&a.error_render(d.add.errors);a.render(d,1)};a.error_render=function(d){d=d[0][1];if(d.type=="alert")alert(d.html);else d.type=="dialog"&&$("#message_dialog").html(d.html)};a.submit_address_form=function(d){d.preventDefault();var c={post_form:"True"};$("[name=shipping_address_block] input, [name=shipping_address_block] select").each(function(){var b=
$(this).attr("name");if(b)c[b]=$(this).val()});$("button[type=submit]",$(this)).paintLoader({canvas_id:"shipping_address_loader",color:"#ffffff",diameter:12,density:71,range:1.1,speed:5,css:{display:"inline"}});$("#canvasLoader").css("display","inline");$.ajax({type:"POST",dataType:"json",data:c,url:"/cart/get_carts_info/",success:function(b){$("#shipping_address_loader").remove();a.render(b,1)}})};a.select_country=function(){country=$(this).children("[selected=selected]").val();$.each(a.carts,function(d,
c){c.change_form()})};a.open=function(){$.hashdata.set("popupopen","Cart");$.each(a.carts,function(d,c){a.addres_exists&&c.open(a.need_update_carts);a.need_update_carts=true})};a.on("click",".itemsUnderBtn",function(){$(this).next().toggle()}).on("submit",'form[name="shipping_address_block"]',a.submit_address_form).on("click","#cart-btnedit-address, #cart-btnadd-address",function(){event.preventDefault();a.$addres_form.toggle()}).on("dialogopen",a.open).on("change","#select_country",a.select_country);
return a}var CART_COUNTDOWNTIME;$(document).ready(function(){if(CART_COUNTDOWNTIME==undefined)CART_COUNTDOWNTIME=3;$.cartWrapper=CartWrapper()});function show_step(){frame=$("#ce-step-frame");frame.slideDown(500,function(){$("#ce-step-wrapper").fadeIn("slow")})}function hide_step(){frame=$("#ce-step-frame");timeout=setTimeout(function(){$("#ce-step-wrapper").fadeOut("slow",function(){frame.slideUp(500,function(){$(".ce-steps").removeClass("active")})})},200);frame.data("close-timeout",timeout)}
function to_step(a,d,c){function b(){frame.html('<div id="ce-step-wrapper" style="display: none;"><div id="ce-step-title">'+d+'</div><div class="ce-step-img-'+a+'"></div></div>')}frame=$("#ce-step-frame");clearTimeout(frame.data("close-timeout"));if(frame.is(":visible")){if(frame.data("current-step")==a)return;$("#ce-step-wrapper").hide();b();$("#ce-step-wrapper").fadeIn("slow")}else{b();show_step()}$(".ce-steps").removeClass("active");$(c).addClass("active");frame.data("current-step",a)};
