$(function(){function C(a){function b(c,d){var h;do{h=a;a=a.replace(c,d)}while(h!=a)}a=tinymce.trim(a);b(/\&quot;/gi,'"');b(/\[td colspan=\"?(\d+)\"?\](.*?)\[\/td\]/gi,"[th=$1]$2[/th]");b(/\[td style=\"width: (.*?)px;\".*?\]/gi,"[td=$1]");b(/\[td.*?\]/gi,"[td]");b(/\[tbody\]/gi,"");b(/\[\/tbody\]/gi,"");b(/<br>|<\/br>|<\/ br>|/gi,"");b(/\[a.*?href=\"(.*?)\".*?\]/gi,"[url=$1]");b(/\[\/a\]/gi,"[/url]");b(/\[table.*?class=\"(.*?)\".*?\]/gi,"[table='$1']");b(/\[table(?!=).*?\]/gi,"[table]");b(/\&nbsp;|\u00a0/gi,
" ");return a}function e(a){var b,c;a.id=="reply_root"&&$(a).hide();if(i){var d=$(a).children("span").length?$(a).children("span"):$(a);if(i==a){b=$(a).text();if(b==gettext("\u0421\u043a\u0440\u044b\u0442\u044c \u0440\u0435\u0434\u0430\u043a\u0442\u043e\u0440"))$(a).show();else b==gettext("\u0421\u043a\u0440\u044b\u0442\u044c \u0440\u0435\u0434\u0430\u043a\u0442\u043e\u0440")&&$(a).hide();for(c in l[0]){if(b==l[0][c]){d.text(l[1][c]);return}if(b==l[1][c]){d.text(l[0][c]);return}}}b=$(i).text();d=
$(i).children("span").length?$(i).children("span"):$(i);i.id=="reply_root"&&$(i).show();for(c in l[0])if(b==l[1][c]){d.text(l[0][c]);break}d=$(a).children("span").length?$(a).children("span"):$(a);b=$(a).text();for(c in l[0])if(b==l[0][c]){d.text(l[1][c]);break}}else $(a).text(l[1][0])}function g(){$("#reply-form").css({"padding-top":"10px"});if(D==="mod"){o&&o.setContent("");$(".comment_body").show()}var a=this,b=$(a).closest(".single_comment");D="add";if(this.id!=="reply_root"&&y(b).length>=J){var c=
b.parentsUntil(".reply").find("."+y(b).slice(0,-4));PF.delay(0,function(){g.call(c.find(".reply_link").get(0));window.scroll(0,c.offset().top-f.height())});return false}if(i===this){f.toggle();e(this);if(!o){k.width=$("#comments").width();k.selector="#reply_root";tinymce.init(k);o=tinymce.activeEditor}return false}$.post("/"+language+"/node/showeditor",{page_id:p,action:"add"},function(d){if(d.success===false)if(z)z=false;else showError(d.errcode,d.nextday);else{z||o.remove();if(a.id=="reply_root"){$(a).after(f);
k.width=$("#comments").width();k.customimage_maxwidth=686;f.css("margin-left","0px");tinymce.init(k)}else{$(a).parents(".single_comment").children(".comment_body").after(f);f.css("margin-left","40px")}f.show();if(z)z=false;else{k.width=k.customimage_maxwidth=$(a).parents(".single_comment").width()-40;tinymce.init(k);o=tinymce.activeEditor}e(a);i=a;if(d.showrateform){d.rating&&$(".current-crating").css("width",d.rating*17+"px");$("#page-rating").show()}else $("#page-rating").hide();q=null}});return false}
function E(a){$elem=$(a);$.post("/"+language+"/node/deleteall",{id:a.id,page_id:p},function(b){b.success===false?showError(b.errcode,b.nextday):location.reload()});$("body").css("cursor","default")}function n(a){var b=this;$.post("/"+language+"/node/modcomment",{type:"rate",id:this.id.split("_")[1],page_id:p,value:a},function(c){if(c.success===false)showError(c.errcode);else{c=parseInt(c.score,10);c<0?$("#"+b.id.split("_")[1]+" .rating_block b").css("color","red"):$("#"+b.id.split("_")[1]+" .rating_block b").css("color",
"green");$("#"+b.id.split("_")[1]+" .rating_block b").text((c>0?"+":"")+c)}})}function u(){var a=this;D="mod";$(".comment_body").show();$.post("/"+language+"/node/showeditor",{action:"mod",page_id:p,id:this.id.split("_")[1]},function(b){if(b.success===false)showError(b.errcode,b.nextday);else{tinymce.activeEditor.remove();$("#reply-form").css({"padding-top":"38px"});$(a).parents(".single_comment").children(".comment_body").after(f);$(a).parents(".single_comment").children(".comment_body").toggle();
f.css("margin-left","0px");f.show();if(b.showrateform){$(".current-crating").css("width",parseInt(b.rating,10)*17+"px");$("#page-rating").show()}else{$("#page-rating").hide();q=null}e(a);i=a;$("#reply-text").val($(a).parents(".single_comment").children(".comment_body").html());k.width=$(this).parents(".single_comment").width();k.selector="#reply-text";tinymce.init(k);o=tinymce.activeEditor}});return false}function G(){var a=$(this).hasClass("like")?"dg":"r",b=$(this).hasClass("like")?gettext("\u0425\u043e\u0440\u043e\u0448\u0438\u0439 \u043a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u0439"):
gettext("\u041f\u043b\u043e\u0445\u043e\u0439 \u043a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u0439");return'<div class="toolTipTop_'+a+'"></div><div class="toolTipMid_'+a+'">'+b+"</div>"}function v(a){var b=parseInt(current_block,10)-1;$.post("/"+language+"/node/getblock",{block_id:[p,K(),b].join(":"),pagecnt:comments_settings.pagecnt,pagenum:b},function(c){if(c.success===false)return c.errcode==="No such block"?undefined:showError(c.errcode);$data=$(c.data);$("#comments").append($data);
$data.find(".like, .unlike").tooltip({bodyHandler:G,left:-25,showUrl:false,track:true,extraClass:"toolTipWrapper"});a&&a.call(a)})}var J=24,y=function(a){return $(a).attr("class").split(" ").filter(function(b){return/^\d+$/.test(b)})[0].trim()};$(".pg_wrapper").hide();needDel=false;tinyMCE.baseURL="http://"+document.domain+"/static/tiny_mce";var k={selector:"#reply-text",height:150,theme:"modern",content_css:"/static/css/tiny_mce.css?dt="+(new Date).getTime(),toolbar:"bold italic underline | subscript superscript | removeformat | outdent indent | undo redo | image uploader link unlink",
language:language,plugins:"preview, lists, code, atomic, customimage, uploader, compat3x, fullscreen, textcolor, bbcode, autoresize, paste, link, youtube, ytlink, uploader, bdesk",extended_valid_elements:"iframe[allowfullscreen|webkitallowfullscreen|mozallowfullscreen|frameborder|width|height|src]",resize:true,paste_text_sticky:true,paste_as_text:true,mode:"textareas",statusbar:false,menubar:false,remove_script_host:false,cleanup:true,entity_encoding:"raw",relative_urls:false,forced_root_block:"",
force_br_newlines:true,force_p_newlines:false,image_advtab:true,add_unload_trigger:true,remove_linebreaks:false,paste_data_images:false,style_formats_merge:true,merge_with_parents:true,inline_styles:false,apply_source_formatting:false,fix_list_elements:true,paste_preprocess:function(a,b){b.content="&zwnj; "+b.content+" &zwnj;";var c=b.content.match(/\&lt;table.*?\&gt;.*?\&lt;\/table\&gt;/gi);if(c){c=c[0].replace(/&lt;/gi,"[").replace(/&gt;/gi,"]");c=C(c);b.content=b.content.replace(/\&lt;table.*?\&gt;.*?\&lt;\/table\&gt;/gi,
c)}},formats:{alignleft:{inline:"p",selector:"p,h1,h2,h3,h4,h5,h6,td,th,div,ul,ol,li,table,img,span,iframe",styles:{"text-align":"left"},exact:true},aligncenter:{inline:"p",selector:"p,h1,h2,h3,h4,h5,h6,td,th,div,ul,ol,li,table,img,span,iframe",styles:{"text-align":"center"},exact:true},alignright:{inline:"p",selector:"p,h1,h2,h3,h4,h5,h6,td,th,div,ul,ol,li,table,img,span,iframe",styles:{"text-align":"right"},exact:true},alignfull:{inline:"p",selector:"p,h1,h2,h3,h4,h5,h6,td,th,div,ul,ol,li,table,img,span,iframe",
styles:{"text-align":"justify"},exact:true},bold:{inline:"strong",exact:true},italic:{inline:"em",exact:true},underline:{inline:"u",exact:true},strikethrough:{inline:"del",exact:true},forecolor:{inline:"font",styles:{color:"%value"},exact:true},hilitecolor:{inline:"span",styles:{backgroundColor:"%value"},exact:true}},setup:function(a){a.on("Init",function(){a.pasteAsPlainText=true;o=a;var b=o.getContent(),c=b.replace(/<a class=\"super-link-wrap\" href=\"(.*?)\"(?:data-mce-href=\".*?\")?[^>]*>[\s\S]*?<\/a>/gi,
"$1");c=b.replace(/<a href=\"(.*?)\" class=\"super-link-wrap\"(?:data-mce-href=\".*?\")?[^>]*>[\s\S]*?<\/a>/gi,"$1");o.setContent(c)});a.on("KeyDown",function(b){if(b.ctrlKey&&b.keyCode==13){f.submit();b.preventDefault();return false}})}};if($("#reply_root").length){var z=true,L=$.cookie("user_id"),p=comments_settings.page_id,f=$('<form id=reply-form name=reply-form method=post><span id=page-rating><span style="display:inline; position:relative; bottom:3px;">'+gettext("\u041e\u0446\u0435\u043d\u0438\u0442\u0435 \u0442\u043e\u0432\u0430\u0440")+
': &nbsp;&nbsp;&nbsp;</span><ul class="cstar-rating" style="display:inline-block; *display:inline"><li class="current-crating">Currently 0/5 Stars.</li><li><a id="s_1" title="1/5" class="cone-star">1 star</a></li><li><a id="s_2" title="2/5" class="ctwo-stars">2 stars</a></li><li><a id="s_3" title="3/5" class="cthree-stars">3 stars</a></li><li><a id="s_4" title="4/5" class="cfour-stars">4 stars</a></li><li><a id="s_5" title="5/5" class="cfive-stars">5 stars</a></li></ul>&nbsp;&nbsp;<a style="display:inline; position: relative; bottom: 3px;" id="s_0" class="comment_link" title="'+
gettext("\u041e\u0442\u043c\u0435\u043d\u0438\u0442\u044c \u043e\u0446\u0435\u043d\u043a\u0443")+'">'+gettext("\u0423\u0431\u0440\u0430\u0442\u044c \u043e\u0446\u0435\u043d\u043a\u0443")+'</a><br /></span><textarea id="reply-text" name="reply-text"></textarea><table class="bt" style="margin-top: 5px;"><tr><td><a id="submit_form"><table class="bt" cellspacing=0><tr><td class="bt_left"></td><td class="bt_middle">'+gettext("\u041e\u0442\u043f\u0440\u0430\u0432\u0438\u0442\u044c")+' <font color="#999999">[Ctrl+Enter]</font></td><td class="bt_right"></td></tr></table></a><td>&nbsp;&nbsp;<a id="reset_form" class="comment_link" style="display:inline">'+
gettext("\u041e\u0442\u043c\u0435\u043d\u0438\u0442\u044c")+"</a></td></tr></table></form>");f.hide().insertAfter("#reply_root");k.width=$("#comments").width();k.customimage_maxwidth=686;var o,l=[[gettext("\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u043e\u0442\u0437\u044b\u0432"),gettext("\u041e\u0442\u0432\u0435\u0442\u0438\u0442\u044c"),gettext("\u0420\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u0442\u044c")],[gettext("\u0421\u043a\u0440\u044b\u0442\u044c \u0440\u0435\u0434\u0430\u043a\u0442\u043e\u0440"),
gettext("\u041e\u0442\u043c\u0435\u043d\u0438\u0442\u044c "),gettext("\u041e\u0442\u043c\u0435\u043d\u0438\u0442\u044c")]],i;g.call($("#reply_root").get(0));var D="add",q=null;$("#submit_form").click(function(){f.submit();return false});$(document).on("click",".reply_link",g);var F={x:0,y:0},A=false;$(document).on("mousedown",".single_comment",function(a){F.x=a.pageX;F.y=a.pageY});$(document).on("dblclick",".single_comment",function(a){A=false;if(!(a.pageX!=F.x||a.pageY!=F.y)){if(window.getSelection)window.getSelection().removeAllRanges();
else document.selection&&document.selection.empty();$(this).children(".author_block").find(".edit_link").hasClass("owner_"+L)?u.call($(this).find(".edit_link").get(0)):g.call($(this).find(".reply_link").get(0))}});$(document).on("click",".single_comment",function(a){if(!A){A=true;var b=this,c=needDel;setTimeout(function(){if(A){A=false;if(c&&confirm(gettext("\u0423\u0434\u0430\u043b\u0438\u0442\u044c \u043a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u0439 \u0438\u043b\u0438 \u0432\u0435\u0442\u043a\u0443?")))E(b);
else{if(a.target instanceof HTMLAnchorElement){var d=window.location.href.slice(0,window.location.href.indexOf(window.location.hash)),h=a.target.href.slice(0,a.target.href.indexOf(a.target.hash)),j=/^#position=(\d+)$/.exec(String(a.target.hash));if(d===h&&j)return $("#"+j[1]).click()}$.hashdata.set("position",b.id);$(".chlt").removeClass("chlt");$(b).addClass("chlt")}}},200)}});$(document).on("click",".hilite_comment",function(a){$e=$(this).parents(".single_comment");$.hashdata.set("position",$e.attr("id"));
$(".chlt").removeClass("chlt");$e.addClass("chlt");a.preventDefault();a.stopPropagation();return false});f.submit(function(a){a.preventDefault();if(!b)var b=tinymce.activeEditor;b.save({outside:true});f.hide();e(i);var c=this;if(D=="add"){a={page_id:p,body:b.getContent()};if(a.body===""||a.body=="<br>"){f.show();showError("Body is empty")}else{if(this.parentNode.id!="comments")a.id=this.parentNode.id;if(q&&q!="0"){a.rating=q;$("#page-rating").hide();q=null}$.post("/"+language+"/node/addcomment",a,
function(d){if(d.success===false)return showError(d.errcode,d.nextday);b.setContent("");var h=$(d).get(0);if(c.parentNode.id=="comments")$("#reply_root").next().next().after(d+'<div class="ctrig"></div><div class="reply"></div>');else if(y(c.parentNode).length==4){$(c.parentNode).next().next().append(d);$(c.parentNode).next().show().next().show()}else{var j;if(parseInt(y(h).slice(-4),10)===1){j=$(c.parentNode);j.addClass("dotted_line");j.find("a[href]:first").wrap('<div class="ava_base">');j.after('<div class="dotted_line_vertical ovf_hidden" style="padding-left:40px;">');
j.next().append(d);d=j.next().children(".single_comment")}else{j=$(c.parentNode);j.next().children(".single_comment:last").children(".close_node").removeClass("close_node").addClass("middle_node");j.next().append(d);d=j.next().children(".single_comment:last")}d.children("a[href]:first").wrap('<div class="close_node">');d.children(".close_node").prepend('<div class="node">').append('<div class="dots_overflow">')}h=h.id;$("#"+h+" .rating_block .unlike, #"+h+" .rating_block .like").tooltip({bodyHandler:G,
left:-25,showUrl:false,track:true,extraClass:"toolTipWrapper"});$("#toLastComment").removeClass("inactive")})}}else{a={id:this.parentNode.id,page_id:p};if(q){a.type="modPRAndBody";a.rating=q;if(a.rating=="0")a.rating=null}else a.type="modBody";a.body=$("#reply-text").val();a.body===""?showError("No comment body"):$.post("/"+language+"/node/modcomment",a,function(d){if(d.success===false)return showError(d.errcode,d.nextday);b.setContent("");$("#"+c.parentNode.id+" .comment_body").replaceWith('<div class="comment_body">'+
d.body+"</div>");d.rating&&d.rating!="null"?$("#"+c.parentNode.id+" .rating_block img").replaceWith('<img src="/static/images/s'+d.rating+'t.gif" alt="'+d.rating+'"/>'):$("#"+c.parentNode.id+" .rating_block img").replaceWith('<img style="display:none;"/>')})}});$("#reset_form").click(function(){f.hide();e(i);$(".comment_body").show();return false});$(document).on("click",".like",function(){n.call(this,1);return false});$(document).on("click",".unlike",function(){n.call(this,-1);return false});$(document).on("click",
".edit_link",u);$(document).on("click",".delete_link",function(){var a=$(this);$.post("/"+language+"/node/deletecomment",{id:this.id.split("_")[1],page_id:p},function(b){if(b.success===false)return showError(b.errcode,b.nextday);if(-1!==a.siblings().get().indexOf(i)){f.hide();$("#reply_root").after(f);i=null}b=a.parents(".single_comment");var c=y(b);if(c.length===4){b.next().remove();b.next().remove();b.remove();$(".single_comment").length||$("#toLastComment").addClass("inactive")}else{if(c.length===
8)b.next().length||b.prev().length||b.parent().prev().hide().next().hide();else if(!b.next().length){if(!b.prev().length){b.parent().prev().removeClass("dotted_line");b.parent().remove();return}b.prev().hasClass("dotted_line_vertical")?b.prev().prev().children(".middle_node").removeClass("middle_node").addClass("close_node"):b.prev().children(".middle_node").removeClass("middle_node").addClass("close_node")}b.remove()}});return false});$("a[id^=s_]").click(function(){q=this.id.split("_")[1];$(".current-crating").css("width",
parseInt(q,10)*17+"px");return false});$(".like, .unlike").tooltip({bodyHandler:G,left:-25,showUrl:false,track:true,extraClass:"toolTipWrapper"});var K=function(){var a={expires:365,path:"/"},b=$("#comments-header-sorting"),c=b.find(".dropdown-menu"),d=[],h=function(m,r){if(0===arguments.length){var s=PF.cookie("commentssorting");return comments_settings.sortings.hasOwnProperty(s)?s:comments_settings.sorting}if(!comments_settings.sortings.hasOwnProperty(m)){s=interpolate(gettext("\u0421\u043e\u0440\u0442\u0438\u0440\u043e\u0432\u043a\u0430 `%s` \u043d\u0435 \u043f\u043e\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044f; \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u044b\u0435: %s."),
[String(m),JSON.stringify(Object.keys(comments_settings.sortings))]);throw PF.createError("InvalidSorting",s);}r||PF.cookie("commentssorting",m,a);return m},j=function(m){var r=h();d.forEach(function(B){var t=B.data("sorting");if(r===t){$(".sort-button").text(comments_settings.sortings[t]);B.children().css("font-weight","bold")}else B.children().css("font-weight","")});if(m){var s=$("#comments_ldr"),w=$("#reply_root");m=""===r?p:[p,r].join(":");i=null;var M=f.is(":visible");f.hide();w.hide().text(l[0][0]);
f.prev().is(w)||f.insertAfter(w);w.nextAll().filter("div").remove();var I=function(){s.hide();w.show();M&&w.click()};s.show();PF.xhr.get("/"+language+"/node/pageinfo/"+m,function(B,t){if(B||!t)return window.location.reload();if(!t.pagecnt)return I();comments_settings.pagecnt=t.pagecnt;comments_settings.sorting=r;current_block=t.pagecnt+1;v(I)})}};Object.keys(comments_settings.sortings).forEach(function(m){var r=$("<a/>").text(comments_settings.sortings[m]).click(function(){if(m!==h()){h(m);j(true)}});
r=$('<li style="cursor: pointer;">').data("sorting",m).append(r);d.push(r)});undefined!==$.hashdata.get("commentssorting")&&$.hashdata.remove("commentssorting");c.append.apply(c,d);h(comments_settings.sorting,true);j(false);b.show();return h}.call(),x=$.hashdata.get("position");if(x)$("#"+x).length?$("#"+x).addClass("chlt"):v(function(){if($("#"+x).length){$("#"+x).addClass("chlt");$.hashdata._scrollTo(x)}else v(this)});$(window).scroll(function(){if(first_comment&&$("#"+first_comment).offset().top<=
$(window).scrollTop()+$(window).height()){first_comment=null;current_block!="0"&&v()}});var H=function(a){return(a=RegExp("[?&]"+a+"=([^&]*)").exec(window.location.search))&&decodeURIComponent(a[1].replace(/\+/g," "))}("commentpage");if(H&&H>0){$(".single_comment, .reply, .ctrig").remove();$("#comments").hide();$("#comments_ldr").show();current_block=comments_settings.pagecnt+1;v(function(){if(current_block==H){$("#comments_ldr").hide();$("#comments").show();$.hashdata._scrollTo(first_comment)}else v(this)})}}});
$(function(){function C(){if($(window).width()>$("#main_container").width()+90){e.removeAttr("style").removeClass("rolled").addClass("unrolled");e.unbind("mouseenter");e.unbind("mouseleave");e.hover(function(){e.addClass("hovered")},function(){e.removeClass("hovered")})}else{e.removeClass("unrolled").addClass("rolled");e.unbind("mouseenter");e.unbind("mouseleave");$.browser.msie&&$.browser.version<8?e.hover(function(){e.removeClass("rolled").addClass("unrolled").addClass("hovered")},function(){e.removeClass("unrolled").addClass("rolled").removeClass("hovered")}):
e.hover(function(){if(!u){e.removeClass("rolled").addClass("hovered").animate({right:"0px"},300);u=true}},function(){e.removeClass("hovered").animate({right:"-35px"},300,function(){u=false;$(this).addClass("rolled")})})}}var e=$("#toLastComment");if(!e.length||$.browser.msie&&$.browser.version<7)e.remove();else{var g=0,E=9223372E12;$(".single_comment").length||e.addClass("inactive");$(".single_comment").each(function(){if(parseInt(this.id,10)>g)g=parseInt(this.id,10)});var n=$("#"+g).get(0);e.click(function(){if(e.hasClass("inactive"))return false;
if(!n){$(".single_comment").each(function(){if(parseInt(this.id,10)>g)g=parseInt(this.id,10)});n=$("#"+g).get(0);if(!n)return false}e.attr("title",gettext("\u041a \u0441\u043b\u0435\u0434\u0443\u044e\u0449\u0435\u043c\u0443 \u043e\u0442\u0437\u044b\u0432\u0443"));window.scrollTo(0,$(n).offset().top);$(".chlt").removeClass("chlt");$(n).addClass("chlt");$.hashdata.set("position",n.id);E=parseInt(n.id,10);g=0;$(".single_comment").each(function(){if(parseInt(this.id,10)>g&&parseInt(this.id,10)<E)g=parseInt(this.id,
10)});g===0&&$(".single_comment").each(function(){if(parseInt(this.id,10)>g)g=parseInt(this.id,10)});n=$("#"+g).get(0);return false});var u=false;$(window).resize(C);C();$("#toLastCommentWrapper").hover(function(){e.hasClass("inactive")||e.addClass("hovered")},function(){e.hasClass("inactive")||e.removeClass("hovered")});$("#toLastCommentWrapper").click(function(){e.click()})}});
